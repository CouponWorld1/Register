if (self.CavalryLogger) { CavalryLogger.start_js(["aoQM1"]); }

__d("CavalryLoggerImpl",["Arbiter","Banzai","Bootloader","ImageTimingHelper","ISB","NavigationTimingHelper","PageEvents","PageletEventConstsJS","PageletEventsHelper","PerfXLogger","ResourceTimingBootloaderHelper","ScriptPath","performance","performanceAbsoluteNow","KillabyteProfilerConfig","__getTotalFactories","__getCompileTime","__getFactoryTime"],(function a(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u){__p&&__p();var v=c("KillabyteProfilerConfig").htmlProfilerModule,w=c("KillabyteProfilerConfig").profilerModule,x="cavalry",y=["t_start","t_paint","t_cstart"],z=window.CavalryLogger;Object.assign(z.prototype,{initializeInstrumentation:function A(){__p&&__p();if(this.instrumentation_started)return;var B=this;h.subscribe("BigPipe/init",function(event,C){if(C.lid==B.lid&&C.arbiter){B.recordTTIEvent(C.arbiter);B.recordDisplayedEvent(C.arbiter);B.recordLoadedEvent(C.arbiter);B.recordPageletEventsTime(C.arbiter)}});h.subscribe(n.BIGPIPE_ONLOAD,function(event,C){if(b.bigPipe&&B.lid===b.bigPipe.lid)B.addPiggyback("cjs_factory_count_e2e",c("__getTotalFactories")()).addPiggyback("cjs_compile_time_e2e",c("__getCompileTime")()).addPiggyback("cjs_factory_time_e2e",c("__getFactoryTime")())});B.addPiggyback("script_path",s.getScriptPath());if(this.is_detailed_profiler)p.init();this.instrumentation_started=true},recordTTIEvent:function A(B){__p&&__p();var C=this;B.subscribe("tti_bigpipe",function(event,D){if(D.lid==C.lid){if(D.metrics)for(var E in D.metrics)C.addPiggyback(E,D.metrics[E]);if(D.usageSnapshot)C.ttiUsageSnapshot=D.usageSnapshot;C.setTTIPhase(D.phase).measurePageLoad(true,D.ts);C.setAbsTimeStamp("t_bigpipe_tti",D.ts,true)}})},recordDisplayedEvent:function A(B){var C=this;B.subscribe("all_pagelets_displayed",function(event,D){if(D.lid===C.lid){if(D.usageSnapshot)C.ddUsageSnapshot=D.usageSnapshot;C.setAbsTimeStamp("t_marker_all_pagelets_displayed",D.ts,true)}})},recordLoadedEvent:function A(B){var C=this;B.subscribe("all_pagelets_loaded",function(event,D){if(D.lid===C.lid)C.setAbsTimeStamp("t_marker_bigpipe_e2e",D.ts,true)})},recordPageletEventsTime:function A(B){__p&&__p();if(this.is_detailed_profiler){var C=this;B.subscribe("pagelet_event",function(event,D){if(D.lid==C.lid){var E=D.id;C.events[E]=C.events[E]||{};C.events[E][D.event]=D.ts-window._cstart;if(D.event===o.ARRIVE_END)C.events[E].phase=D.phase}})}},setTTIPhase:function A(B){this.addPiggyback("tti_phase",B);return this},setTimeStamp:function A(B,C,D,E){this.mark(B);var F=this.values.t_cstart||this.values.t_start,G=E?F+E:u();this.setValue(B,G,C,D);if(this.tti_event&&B==this.tti_event)this.measurePageLoad(C);return this},setAbsTimeStamp:function A(B,C,D,E){this.setValue(B,C,D,E);if(this.tti_event&&B==this.tti_event)this.measurePageLoad(D,C);return this},logE2E:function A(){var B={lid:this.lid,t_creport:u(),cavalry_e2e:true};if(l.token)B.fb_isb=l.token;for(var C=0;C<y.length;C++)B[y[C]]=this.values[y[C]];i.post(x,B,{signal:true,retry:false});this.e2eLogged=true},log:function A(){__p&&__p();if(!this.e2eLogged)this.logE2E();var B={lid:this.lid};if(l.token)B.fb_isb=l.token;this.addPiggyback("pagelet_events",p.getMetrics(this.lid));this.setValue("client_pixel_ratio_10x",parseInt((window.devicePixelRatio||1)*10,10));this.moveBootloaderData();var C=babelHelpers["extends"]({t_creport:u()},B,this.values,this.piggy_values),D=window.__bodyWrapper;if(D.getCodeUsage&&w){if(!this.start||!this.e2e||!this.dd)throw new Error("Timestamps are missing in Cavalry. Please report this to the Web Speed team");var E=w.findUsedCSSSelectors(document,w.getDocumentStylesheets(document)),F={js_calls:JSON.stringify(D.getCodeUsage()),css_selectors:JSON.stringify(E),bootloads:JSON.stringify(this.getBootloadsUntil(this.e2e))};if(v)F.html=JSON.stringify(v.getKillabyteHTMLData());var G=babelHelpers["extends"]({},w.getDataForSnapshot(this.ddUsageSnapshot),{bootloads:JSON.stringify(this.getBootloadsUntil(this.dd))}),H={e2e:F,dd:G};if(this.ttiUsageSnapshot){if(!this.tti)throw new Error("tti timestamp should always be present if we have usage data");H.tti=babelHelpers["extends"]({},w.getDataForSnapshot(this.ttiUsageSnapshot),{bootloads:JSON.stringify(this.getBootloadsUntil(this.tti))})}h.inform("cavalry_usage_data_collected",{usageData:H,lid:this.lid},h.BEHAVIOR_STATE);D.clearCodeUsage()}var I=q.getPayload(C.lid);if(I)this.logPerfXPiggybacks(C,I);i.post(x,C,i.VITAL);var J=this.values;this.values={};this.piggy_values={};for(var K=0;K<y.length;K++)this.values[y[K]]=J[y[K]];h.inform("cavalry_log_sent",C,h.BEHAVIOR_STATE)},logPerfXPiggybacks:function A(B,C){B.perfx_page=C.perfx_page;B.perfx_page_type=C.perfx_page_type;B.perfx_tti=C.tti;B.perfx_e2e=C.e2e},logPiggybacks:function A(){this.moveBootloaderData();var B=babelHelpers["extends"]({lid:this.lid},this.piggy_values);this.piggy_values={};i.post(x,B,i.VITAL)},moveBootloaderData:function A(){if(this.log_resources)this.addPiggyback("resource_timing_bootloader",r.mergeBootloaderMetricsAndResourceTimings(this.piggy_values.resource_timing_bootloader,this.bootloader_metrics,false,{}))},collectMetrics:function A(B){if(!this.metric_collected||B){this.metric_collected=true;this.addPiggyback("tag",document.getElementsByTagName("*").length)}},getBootloadsUntil:function A(B){return Object.entries(j.getBootloadedComponents()).filter(function(C){var D=C[0],E=C[1];return E>=this.start&&E<=B}.bind(this)).map(function(C){var D=C[0],E=C[1];return D})},measurePageLoad:function A(B,C){if(C)this.setAbsTimeStamp("t_tti",C,B);else this.setTimeStamp("t_tti",B);this.collectMetrics(B)},collectBrowserTiming:function A(B){__p&&__p();if(t.timing){this.start=t.timing.navigationStart;this.tti=this.values.t_bigpipe_tti;this.dd=this.values.t_marker_all_pagelets_displayed;this.e2e=this.values.t_onload;var C=m.getNavTimings();this.addPiggyback("navigation_timing",C);if(this.log_resources){this.addPiggyback("resource_timing_bootloader",r.getMetrics(0,false).data);this.collectTTIAndE2EWithImages()}}},collectTimingForAsync:function A(B,C){__p&&__p();if(!C)return;if(t.timing&&t.getEntriesByName){var D=t.getEntriesByName(C);if(D.length===0)return;this.start=t.timing.navigationStart+D[0].startTime;this.tti=this.values.t_bigpipe_tti;this.e2e=this.values.t_onload;var E=m.getAsyncRequestTimings(C);this.addPiggyback("navigation_timing",E);if(this.log_resources){this.addPiggyback("resource_timing_bootloader",r.getMetrics(D[0].startTime,false).data);this.collectTTIAndE2EWithImages()}}},collectTTIAndE2EWithImages:function A(){var B=t.timing.navigationStart,C=this.values.t_bigpipe_tti,D=this.values.t_marker_bigpipe_e2e,E=k.getImageTimings(this.lid),F=r.getLastTTIAndE2EImageResponseEnds(C,D,E);if(!isNaN(F.TTI)&&F.TTI!==B)this.setAbsTimeStamp("t_tti_with_images",F.TTI);if(!isNaN(F.E2E)&&F.E2E!==B)this.setAbsTimeStamp("t_marker_bigpipe_e2e_with_images",F.E2E)},collectTiming:function A(B,C,D){var E=["connectEnd","connectStart","domComplete","domContentLoadedEventEnd","domContentLoadedEventStart","domInteractive","domLoading","domainLookupEnd","domainLookupStart","fetchStart","loadEventEnd","loadEventStart","navigationStart","redirectEnd","redirectStart","requestStart","responseEnd","responseStart","secureConnectionStart","startTime","unloadEventEnd","unloadEventStart"];for(var F=0;F<E.length;F++){var G=E[F];if(C[G])this.setAbsTimeStamp(B+G,C[G]+D,true)}}});Object.assign(z,{startInstrumentation:function A(){for(var B in z.instances){var C=z.instances[B];C.initializeInstrumentation();if("t_tti"in C.values)C.measurePageLoad(false,C.values.t_tti)}},hookLogOnLoad:function A(B){h.registerCallback(function(){z.setPageID(B);z.instances[B].log()},[n.NATIVE_ONLOAD])}});f.exports=z}),null);